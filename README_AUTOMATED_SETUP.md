# Automated AD Lab Setup

This guide explains how to use the automated setup process to create an Active Directory lab environment with proper networking configuration.

## Prerequisites

1. Proxmox VE environment with at least one node
2. Python 3.6 or later installed
3. Administrative access to the Proxmox node
4. Windows Server ISO available in Proxmox storage

## Files Overview

- `build_ad_lab.sh` - Master build script that automates everything
- `create_ad_environment.py` - Creates VMs in Proxmox (from existing codebase)
- `configure_ad.ps1` - Configures Active Directory (from existing codebase)
- `create_ad_users.ps1` - Creates AD users (from existing codebase)
- `configure_vm_networking.ps1` - Configures VM networking (generated by build script)
- `setup_connectivity.ps1` - Sets up VM connectivity (generated by build script)
- `extend_config.yaml` - Stores VM IDs and configuration for networking automation
- `config.yaml` - Main configuration file (from existing codebase)

## Setup Process

### 1. Prepare Configuration

1. Make sure your `config.yaml` file is properly configured:
   - Correct Proxmox node information
   - Windows ISO locations
   - Domain settings
   - VM specifications

2. Apply the patch to `create_ad_environment.py`:
   ```bash
   patch -p0 < update_create_ad_environment.py.patch
   ```

### 2. Run the Automated Build Script

Execute the master build script:

```bash
chmod +x build_ad_lab.sh
./build_ad_lab.sh
```

The script will:
1. Verify prerequisites (Python, required files)
2. Create VMs using the Python script
3. Generate network configuration scripts
4. Optionally configure networking automatically

### 3. Manual Steps (if automatic networking configuration is skipped)

If you choose to skip automatic network configuration, follow the instructions in `network_config_instructions.txt`.

## Troubleshooting

### VM Creation Issues

1. Check Proxmox API connectivity:
   ```bash
   python3 -c "from proxmoxer import ProxmoxAPI; p=ProxmoxAPI('your-proxmox-host', user='root@pam', token_name='yourtoken', token_value='yourvalue', verify_ssl=False); print(p.nodes.get())"
   ```

2. Verify Windows ISO availability:
   ```bash
   pvesh get /storage/local/content
   ```

### Networking Issues

1. Verify network configuration on SANCTUM:
   ```powershell
   Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "IPEnableRouter"
   Get-NetNat
   ```

2. Check routes on SHIELD-HQ:
   ```powershell
   Get-NetRoute -DestinationPrefix "0.0.0.0/0"
   ```

3. Test connectivity:
   ```powershell
   Test-NetConnection -ComputerName 192.168.1.11
   Test-NetConnection -ComputerName 8.8.8.8
   ```

## Additional Notes

- The automatic network configuration uses QEMU guest agent to deploy and execute scripts on the VMs
- Make sure the QEMU guest agent is installed and running on all VMs
- VM networking changes require a restart to take full effect
- If changes to the script are needed, edit `build_ad_lab.sh` directly 